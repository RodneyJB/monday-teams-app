const express = require('express');
const session = require('express-session');
const axios = require('axios');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 5000;

const clientId = '53b916a33737930db9de0faa9718b881';
const clientSecret = '78973e7f1274e56626158c1ec3853838';
const redirectUri = 'https://monday-teams-app.onrender.com/oauth/callback';

app.use(session({
  secret: 'your_secret',
  resave: false,
  saveUninitialized: true
}));

app.use(express.static(path.join(__dirname, '../public')));

app.get('/login', (req, res) => {
  const url = `https://auth.monday.com/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}`;
  res.redirect(url);
});

app.get('/auth-popup', (req, res) => {
  const state = 'teams';
  const url = `https://auth.monday.com/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&state=${state}`;
  res.send(`<script>window.location.href='${url}'</script>`);
});

app.get('/oauth/callback', async (req, res) => {
  const code = req.query.code;
  const state = req.query.state;

  try {
    const tokenRes = await axios.post('https://auth.monday.com/oauth2/token', {
      client_id: clientId,
      client_secret: clientSecret,
      code,
      redirect_uri: redirectUri
    });

    const accessToken = tokenRes.data.access_token;
    req.session.token = accessToken;
    console.log('✅ Access token saved:', accessToken);

    if (state === 'teams') {
      res.send(`
        <script>
          sessionStorage.setItem('monday_token', '${accessToken}');
          window.opener.microsoftTeams.authentication.notifySuccess('success');
          window.close();
        </script>
      `);
    } else {
      res.redirect('/');
    }
  } catch (err) {
    console.error('❌ Error exchanging token:', err.response?.data || err.message);
    res.status(500).send('OAuth error');
  }
});

app.get('/me', async (req, res) => {
  const token = req.session?.token;
  if (!token) return res.status(401).json({ error: 'Not authenticated' });

  try {
    const query = { query: `query { me { name email time_zone_identifier } }` };
    const result = await axios.post('https://api.monday.com/v2', query, {
      headers: {
        Authorization: token,
        'Content-Type': 'application/json'
      }
    });
    res.json(result.data.data.me);
  } catch (err) {
    console.error('❌ Error fetching user info:', err.response?.data || err.message);
    res.status(500).json({ error: 'Failed to fetch user info' });
  }
});

app.listen(PORT, () => {
  console.log(`🚀 Server running at http://localhost:${PORT}`);
});
